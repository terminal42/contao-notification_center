var AutoSuggester=new Class({Implements:Options,options:{rgxp:"[^ |\n]+$",class_input_mirror:"autosuggester-input-mirror",class_input_mirror_container:"autosuggester-input-mirror-container",class_input_mirror_caret:"autosuggester-input-mirror-caret",class_box:"autosuggester-box",class_box_container:"autosuggester-box-container",class_box_list:"autosuggester-box-list",class_box_list_item:"autosuggester-box-list-item",class_box_list_item_active:"autosuggester-box-list-item-active",class_box_list_item_value:"autosuggester-box-list-item-value",class_box_list_item_content:"autosuggester-box-list-item-content"},keys_mapper:{13:"enter",27:"esc",38:"up",40:"down"},initialize:function(t,i,s){this.input=t,this.setOptions(s),this.source=i,this.tinyMCE=!1,this.rgxp=new RegExp(this.options.rgxp,"i"),this.input.set("autocomplete","off"),setTimeout(function(){if(window.tinyMCE)try{this.tinyMCE=tinyMCE.get(this.input.get("id"))}catch(t){}"textarea"!=this.input.get("tag")||this.tinyMCE||this.setUpMirror(),this.setUpSuggestions(),this.registerObservers()}.bind(this),500)},setUpSuggestions:function(){var t;for(this.box_container=new Element("div",{class:this.options.class_box_container}),this.box=new Element("div",{id:this.input.get("id")+"_autosuggester",class:this.options.class_box}),this.box_list=new Element("ul",{class:this.options.class_box_list}),this.box_list_items=[],this.box_list_items_visible=[],t=0;t<this.source.length;t+=1)this.box_list_items[t]=new Element("li",{class:this.options.class_box_list_item,html:'<div class="'+this.options.class_box_list_item_value+'">'+this.source[t].value+'</div><div class="'+this.options.class_box_list_item_content+'">'+this.source[t].content+"</div>"}).inject(this.box_list),this.box_list_items_visible.push(t);this.box_list.inject(this.box),this.box.inject(this.box_container),this.box_container.inject(document.body),this.box_visible=!1},setUpMirror:function(){var t,i=["box-sizing","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","line-height","max-height","min-height","padding-bottom","padding-left","padding-right","padding-top","text-decoration","text-indent","text-transform","width","word-spacing"],s=window.getComputedStyle(this.input);for(this.input_mirror=new Element("div",{class:this.options.class_input_mirror,text:this.input.get("value")}),this.input_mirror_caret=new Element("span",{class:this.options.class_input_mirror_caret,html:"&nbsp;"}),t=0;t<i.length;t++)this.input_mirror.setStyle(i[t],s[i[t]]);this.input_mirror_caret.inject(this.input_mirror),this.input_mirror.inject(this.input,"after")},registerObservers:function(){var t;for(this.tinyMCE||this.input.addEvents({keyup:this.eventKeyUp.bind(this),keydown:this.eventKeyDown.bind(this)}),this.tinyMCE&&("function"==typeof this.tinyMCE.on?(this.tinyMCE.on("keyUp",function(t){this.eventKeyUp.call(this,t)}.bind(this)),this.tinyMCE.off("keyDown"),this.tinyMCE.on("keyDown",function(t){this.eventKeyDown.call(this,t)}.bind(this))):(this.tinyMCE.onKeyUp.add(function(t,i){this.eventKeyUp.call(this,i)}.bind(this)),this.tinyMCE.onKeyDown.listeners=[],this.tinyMCE.onKeyDown.add(function(t,i){this.eventKeyDown.call(this,i)}.bind(this)))),t=0;t<this.box_list_items.length;t++)this.box_list_items[t].addEvents({mouseenter:function(t){this.highlightItem(this.box_list_items.indexOf(t.target))}.bind(this),click:function(t){t.preventDefault(),this.selectItem()}.bind(this)})},showBox:function(){if(!this.box_visible){var t,s,e,n={x:0,y:0};for(this.tinyMCE?(n.x=this.tinyMCE.selection.getRng().getClientRects()[0].left,n.y=this.tinyMCE.selection.getNode().getClientRects()[0].top+this.tinyMCE.selection.getNode().getClientRects()[0].height):this.input_mirror?(t=this.getCaretIndex(),e=[(s=this.input.get("value")).substr(0,t),s.substr(t,s.length)],this.input_mirror.set("html",""),this.input_mirror.grab(document.createTextNode(e[0])),this.input_mirror.grab(this.input_mirror_caret),this.input_mirror.grab(document.createTextNode(e[1])),(n=this.input_mirror_caret.getPosition(this.input_mirror)).y=n.y+this.input_mirror_caret.getSize().y):n.y=this.input.getSize().y,i=0;i<this.box_list_items.length;i++)this.box_list_items[i].removeClass("invisible");this.tinyMCE?this.setPosition(this.box_container,$(this.input.get("id")+"_ifr").getPosition()):this.setPosition(this.box_container,this.input.getPosition()),this.current_list_item=null,this.box.setStyle("display","block"),this.setPosition(this.box,n),this.box.scrollTo(0,0),this.box_visible=!0,document.body.addEvent("click",this.hideBox.bind(this))}},hideBox:function(){for(this.box.setStyle("display","none"),this.box_visible=!1,i=0;i<this.box_list_items.length;i++)this.box_list_items[i].removeClass(this.options.class_box_list_item_active)},eventKeyUp:function(t){if("esc"!=this.getKeyCode(t)){var i,s,e,n;this.tinyMCE?(i=(e=this.tinyMCE.selection.getRng()).startContainer.wholeText,s=e.startOffset,i&&s==e.startContainer.length&&e.startContainer.textContent.length!=i.length&&(s+=i.length-e.startContainer.textContent.length)):(i=this.input.get("value"),s=this.getCaretIndex()),i?(this.filter_text="",i=i.slice(0,s),(n=this.rgxp.exec(i))&&(this.showBox(),this.filter_text=n[0],this.filterItems()||this.hideBox())):this.hideBox()}},eventKeyDown:function(t){if(this.box_visible){var i=this.box_list_items_visible.indexOf(this.current_list_item);switch(this.getKeyCode(t)){case"esc":this.hideBox();break;case"enter":if(null===this.current_list_item)return;t.preventDefault(),this.selectItem();break;case"up":t.preventDefault(),-1===i?this.highlightItem(this.box_list_items_visible.length-1):i>0&&this.highlightItem(this.box_list_items_visible[i-1]);break;case"down":t.preventDefault(),-1===i?this.highlightItem(this.box_list_items_visible[0]):i<this.box_list_items_visible.length-1&&this.highlightItem(this.box_list_items_visible[i+1])}}},highlightItem:function(t){var i=parseInt(this.box.getStyle("maxHeight")),s=this.box.getScroll().y,e=i+s,n=this.box_list_items[t].getPosition(this.box).y+s,o=n+this.box_list_items[t].getCoordinates().height;null!==this.current_list_item&&this.box_list_items[this.current_list_item].removeClass(this.options.class_box_list_item_active),this.box_list_items[t].addClass(this.options.class_box_list_item_active),this.current_list_item=t,o>=e?this.box.scrollTo(0,o-i>0?o-i:0):n<s&&this.box.scrollTo(0,n)},selectItem:function(){var t,i,s,e=this.source[this.current_list_item].value;this.filter_text.length>0&&(e=e.substr(this.filter_text.length,e.length)),this.tinyMCE?this.tinyMCE.selection.setContent(e):(t=this.input.get("value"),s=(i=this.getCaretIndex())+e.length,this.input.set("value",t.slice(0,i)+e+t.slice(i,t.length)),this.input.setSelectionRange(s,s)),this.hideBox()},filterItems:function(){var t,i=new RegExp("^"+this.filter_text+"(?!$)","i");for(t=0;t<this.box_list_items.length;t++)i.test(this.source[t].value)?(this.box_list_items[t].removeClass("invisible"),this.box_list_items_visible.include(t)):(this.box_list_items[t].addClass("invisible"),this.box_list_items_visible.erase(t));return this.box_list_items_visible.length>0},getCaretIndex:function(){return this.input.selectionStart},getKeyCode:function(t){var i;return i=this.tinyMCE?t.keyCode:t.event.keyCode,this.keys_mapper[i]},setPosition:function(t,i){t.setStyle("left",i.x),t.setStyle("top",i.y)}});